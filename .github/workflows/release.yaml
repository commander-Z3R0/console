name: Build ARM64 Console (.deb)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install cross deps
      run: |
        sudo dpkg --add-architecture arm64
        sudo apt update
        sudo apt install -y \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          meson ninja-build gettext gi-docgen \
          libglib2.0-dev:arm64 libgirepository1.0-dev:arm64 \
          libgtk-4-dev:arm64 libadwaita-1-dev:arm64 \
          libvte-2.91-dev:arm64 libprocps-dev:arm64 \
          libnl-3-dev:arm64 libnl-route-3-dev:arm64 \
          libpcre2-dev:arm64 libxml2-dev:arm64 \
          libgdk-pixbuf-2.0-dev:arm64 libsystemd-dev:arm64

    - name: Configure Meson (cross build)
      run: |
        meson setup build_arm64 \
          --cross-file aarch64.txt \
          --prefix=/usr

    - name: Build
      run: ninja -C build_arm64

    - name: Install to pkg/ directory
      run: |
        DESTDIR=pkg meson install -C build_arm64

    - name: Create .deb package
      run: |
        mkdir -p pkg/DEBIAN
        cat > pkg/DEBIAN/control <<EOF
          Package: gnome-console
          Version: 1.0
          Architecture: arm64
          Maintainer: GitHub Actions
          Depends: libc6, libgtk-4-1, libadwaita-1-0, libvte-2.91-0
          Description: GNOME Console compiled for ARM64
        EOF
        dpkg-deb --build pkg gnome-console_arm64.deb

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gnome-console_arm64
        path: gnome-console_arm64.deb

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: gnome-console_arm64.deb
