name: Build ARM64 Console

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install QEMU + debootstrap
      run: |
        sudo apt update
        sudo apt install -y qemu-user-static binfmt-support debootstrap

    - name: Create ARM64 rootfs
      run: |
        sudo debootstrap --arch=arm64 jammy arm64-rootfs http://ports.ubuntu.com/

    - name: Mount system dirs into chroot
      run: |
        sudo mount --bind /dev arm64-rootfs/dev
        sudo mount --bind /dev/pts arm64-rootfs/dev/pts
        sudo mount --bind /proc arm64-rootfs/proc
        sudo mount --bind /sys arm64-rootfs/sys

    - name: Copy QEMU into chroot
      run: sudo cp /usr/bin/qemu-aarch64-static arm64-rootfs/usr/bin/

    - name: Install build dependencies inside ARM64 chroot
      run: |
        sudo chroot arm64-rootfs /bin/bash -c "
          apt update &&
          apt install -y \
            build-essential meson ninja-build gettext gi-docgen \
            libglib2.0-dev libgirepository1.0-dev libgtk-4-dev libadwaita-1-dev \
            libvte-2.91-dev libprocps-dev libnl-3-dev libnl-route-3-dev \
            libpcre2-dev libxml2-dev libgdk-pixbuf-2.0-dev libsystemd-dev
        "

    - name: Copy source into ARM64 rootfs
      run: sudo cp -r . arm64-rootfs/src

    - name: Build inside ARM64
      run: |
        sudo chroot arm64-rootfs /bin/bash -c "
          cd /src &&
          meson setup build --prefix=/usr &&
          ninja -C build &&
          DESTDIR=/pkg meson install -C build
        "

    - name: Build ARM64 .deb
      run: |
        mkdir -p arm64-rootfs/pkg/DEBIAN
        cat > arm64-rootfs/pkg/DEBIAN/control <<EOF
          Package: gnome-console
          Version: 1.0
          Architecture: arm64
          Maintainer: GitHub Actions
          Depends: libc6, libgtk-4-1, libadwaita-1-0, libvte-2.91-0
          Description: GNOME Console compiled for ARM64
        EOF

        dpkg-deb --build arm64-rootfs/pkg console_arm64.deb

    - name: Unmount chroot (cleanup)
      if: always()
      run: |
        sudo umount -lf arm64-rootfs/dev/pts || true
        sudo umount -lf arm64-rootfs/dev || true
        sudo umount -lf arm64-rootfs/proc || true
        sudo umount -lf arm64-rootfs/sys || true

    - uses: actions/upload-artifact@v4
      with:
        name: console_arm64
        path: console_arm64.deb
